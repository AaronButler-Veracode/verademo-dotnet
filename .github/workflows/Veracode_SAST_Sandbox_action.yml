# This workflow will initiate a Veracode Static Analysis Sandbox scan.

name: Veracode Static Analysis Sandbox Scan

on:
#   push:
#     branches: [ "main" ]
#   pull_request:
#     # The branches below must be a subset of the branches above
#     branches: [ "main" ]
# Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
# Run daily at 6pm GMT
  schedule:
    - cron: '00 18 * * *'
    
jobs:
  build:
    runs-on: ubuntu-latest
  
#     runs-on: windows-latest
    steps:
    - uses: actions/checkout@v3
      with:
        repository: ${{ inputs.repository }}
        ref: ${{ inputs.ref }}
        token: ${{ inputs.token }}
    - name: Setup .NET Core
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '3.1.x'
    - name: Build
      run: |
        dotnet restore
        dotnet publish -c Debug -o ./output
    - name: Create zip archive
      run: zip -r veracode.zip ./output

#     - name: Setup .NET
#       run: |
#         choco install dotnetcore-sdk -y
#         dotnet --version
#     - name: Build application
#       run: |
#         dotnet restore
#         dotnet publish -c Debug -o ./output
        
#     - name: Setup 7zip
#       run: |
#         choco install 7zip -y
        
#     - name: Create zip archive
#       run: 7z a -tzip veracode.zip ./output
        
    - name: Upload & Scan
      uses: veracode/veracode-uploadandscan-action@0.2.4
      with:
        appname: ${{ github.repository }}
        createprofile: false
        filepath: 'veracode.zip'
        version: ${{ github.run_id }}-${{ github.run_number }}-${{ github.run_attempt }}
        vid: ${{ secrets.VERACODE_API_ID }}
        vkey: ${{ secrets.VERACODE_API_KEY }}
        createsandbox: false 
        scantimeout: 45
